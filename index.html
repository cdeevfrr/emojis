
<body>
    <div style="justify-content: center; text-align: center; display: flex">
        <div>
            <p id="leftNotification" style="height: 100px"></p>
            <p>
                Move with asdw
            </p>
            <p>
                Grow (enter) or Harvest (h) your crops!
            </p>
        </div>
        <textarea id="mainScreen" readonly style="height:8.6em; width: 7.2em ; font-size: 10vmin; text-align: center; margin:auto">
        </textarea>
        <div>
            <p id="rightNotification" style="height: 100px"></p>
            <p>T gives a little bit of energy üòâ</p>
        </div>

    </div>
    <div style="text-align: center; justify-content: center;">
        <div>
            <p id="playerStats" style="color: green"></p>
        </div>
    </div>
</body>


<script>

// These things can be done before document loading.
const playerLocation = {x: 3, y: 3}
let playerDirection = "d"
let playerMoney = 0
let playerEnergy = 40

const mapString = 
`9999999999999999999
9001000011100000000
9020003011100000080
9000103011100000080
9000003011100000080
9100000011100000080`
const map = mapString.split("\n").map(x => Array.from(x).map(char => Number(char)))

const imageFor = {
    0: "_",
    1: ".",
    2: ",",
    3: "+",
    4: "i",
    5: "l",
    6: ")",
    7: "|",
    8: "T",
    9: "‚ñì",
}

const defaultWidth = 11
const defaultHeight= 7



const blockingMovementStrings = new Set([
    7,
    8,
    9,
])

// You can only harvest between values 5 and 8 (inclusive)
// Harvesting reduces size by 4
// Things only grow by themselves between 3 and 7 (inclusive)
// So harvesting at 5 or 6 is detrimental - you should wait for 7 or 8.

/// Begin async stuff
window.onload = async function(){
    
    /**
     * @type HTMLTextAreaElement
     */ 
    const mainScreen = document.getElementById("mainScreen")
    const playerStats = document.getElementById("playerStats")
    const leftNotification = document.getElementById("leftNotification")
    const rightNotification = document.getElementById("rightNotification")


    mainScreen.onclick = () => {
        mainScreen.requestPointerLock()
    }

    document.addEventListener('pointerlockchange',pointerLockChangeListener, false);
    let tickInterval = null

    function pointerLockChangeListener(){
        if (document.pointerLockElement === mainScreen){
            console.log("Adding listeners")
            mainScreen.addEventListener('keydown', handleKeypress)
            tickInterval = tickInterval ||  setInterval(tick, 1000)
        } else {
            console.log("Removing listeners")
            mainScreen.removeEventListener('keydown', handleKeypress, true)

            if(tickInterval){
                clearInterval(tickInterval)
                tickInterval = null
            }
        }
    }

    function printLocation({
        x = playerLocation.x, 
        y = playerLocation.y, 
        width = defaultWidth, 
        height = defaultHeight
    }){
        const toPrint = []
        // the point (x=0, y=0) is the top left. Positive y is down.
        for (let j = y - Math.floor(height/2); j < y + Math.ceil(height / 2); j += 1){
            const row = []
            for (let i = x- Math.floor(width/2); i < x + Math.ceil(width / 2); i+=1){
                row.push(findImageFor(map[j]?.[i]))
            }
            toPrint.push(row)
        }
        // Show the player in the center instead.
        toPrint[Math.floor(height / 2)][Math.floor(width / 2)] = playerIcon[playerDirection]

        mainScreen.value = toPrint.map(row => row.join("")).join("\n")

        playerStats.innerText = `Money: \$${playerMoney}  Energy: ${Math.floor(playerEnergy)}`
    }

    function findImageFor(mapNumber){
        if (mapNumber in imageFor){
            return imageFor[mapNumber]
        }

        return "0"
    }



    /**
     * @param {KeyboardEvent} event 
     */ 
    function handleKeypress(event){
        console.log(`"Got event ${event.key}`)

        if (event.key in directions){
            move(event.key)
        }

        if (event.key == "Enter"){
            handleGrowInteraction()
        }

        if (event.key == "h"){
            harvest()
        }

        printLocation({})


    }

    const playerIcon = {
        "d": "üòó",
        "s": "üôÉ",
        "a": "üßê",
        "w": "üôÇ",
    }

    const directions = {
        a: {x: -1, y: 0},
        s: {x: 0,  y: 1},
        d: {x: 1,  y: 0},
        w: {x: 0,  y: -1},
    }

    function interactingLocation(directionKey){
        const toAdd = directions[directionKey]

        return {
            x: playerLocation.x + toAdd.x,
            y: playerLocation.y + toAdd.y,
        }
    }

    const dollarsPerHarvestStage = {
        5: 4,
        6: 4,
        7: 8,
        8: 4
    }
    const decrementPerHarvestStage = {
        5: 4,
        6: 4,
        7: 4,
        8: 4
    }
    const energyUsePerHarvestStage = {
        5: 1,
        6: 1,
        7: 1,
        8: -1,
    }

    function harvest(){
        const targetLocation = interactingLocation(playerDirection)
        console.log(`Handling harvest interaction at ${JSON.stringify(targetLocation)}`)
        let target = map[targetLocation.y]?.[targetLocation.x]

        if (!target){
            return
        }

        if (target == 9){
            return;
        }

        if (target < 5){
            return;
        }

        if (target < 9 && playerEnergy > 1){
            playerEnergy -= energyUsePerHarvestStage[target]
            increasePlayerMoney(dollarsPerHarvestStage[target])
            target -= decrementPerHarvestStage[target]
        }

        if (target > 9 && playerEnergy > 2){
                playerEnergy -= 2
                target = 0
        }

        console.log(`setting map location to new value ${target}`)

        map[targetLocation.y][targetLocation.x] = target
    }

    function increasePlayerMoney(grownAmount){
        playerMoney += grownAmount
        notify(`+ $${grownAmount}`)
    }

    /**
     * @type 
     */ 
    let endNotificationTimer = null
    function notify(toNotify){
        leftNotification.innerText = toNotify
        rightNotification.innerText = toNotify

        if (endNotificationTimer){
            clearTimeout(endNotificationTimer)
        }
        endNotificationTimer = setTimeout(endNotification, 1000)
    }

    function endNotification(){
        leftNotification.innerText = ""
        rightNotification.innerText = ""
        endNotificationTimer = null
    }

    function handleGrowInteraction(){
        const targetLocation = interactingLocation(playerDirection)
        console.log(`Handling grow interaction at ${JSON.stringify(targetLocation)}`)

        if (playerEnergy < 1){
            return
        }
        playerEnergy -= 1


        // Expand the map if you interacted off the edge of it.
        if (targetLocation.y == map.length){
            console.log("Expanding the map downward!")
            map.push(new Array(map[0].length).fill(-1))
            map[map.length - 1][0] = 9
        }
        if (targetLocation.x == map[0].length){
            console.log("Expanding the map rightward!")
            map.forEach(row => row.push(-1))
            map[0][map[0].length - 1] = 9
        }

        const target = map[targetLocation.y]?.[targetLocation.x]

        if (target == 9){
            return
        }
        
        // For now, just increment the target by 1.
        // We're skipping 9 because I'm reserving 9 for "can't be modified" (so you can add permanent walls to the map)
        map[targetLocation.y][targetLocation.x] = target == 8? target + 2 : target + 1

    }

    function move(directionKey){
        playerDirection = directionKey
        const newLocation = interactingLocation(directionKey)

        const canMoveThere = canMove(newLocation.x, newLocation.y)

        if(canMoveThere){
            playerLocation.x = newLocation.x
            playerLocation.y = newLocation.y
        }
    }

    function canMove(x, y){
        return 0 <= y && y < map.length 
        && 0 <= x && x < map[y].length 
        && ! blockingMovementStrings.has(map[y][x])
        && map[y][x] in imageFor;
    }

    function tick(){
        console.log("Running tick");
        // Grow things
        for (const row of map){
            for (let i = 0; i < row.length; i ++){
                if (3 <= row[i] && row[i] <= 7 && Math.random() < .08){
                    row[i] += 1
                }
            }
        }
        // Gain energy
        playerEnergy += .25
        if (playerEnergy > 100){
            playerEnergy = 10
        }

        printLocation({})
    }


    printLocation({})
}
</script>
