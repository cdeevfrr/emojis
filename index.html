
<body>
    <div style="justify-content: center; text-align: center">
    <textarea id="mainScreen" readonly style="height:8.2em; width: 7.2em ; font-size: 10vmin; text-align: center; margin:auto">

    </textarea>
    </div>
    <div style="text-align: center">
        <p>
            Move with asdw
        </p>
        <p>
            Interact with a tile using enter 
        </p>
    </div>
</body>


<script>

// These things can be done before document loading.
const playerLocation = {x: 3, y: 3}
let playerDirection = "d"
const mapString = 
`0000000011100000000
0001000011100000000
0020000011100000000
0000100011100000000
0000000011100000000
0100000011100000000
`
const map = mapString.split("\n").map(x => Array.from(x).map(char => Number(char)))

const imageFor = {
    0: "_",
    1: "#",
    2: "*",
}

const defaultWidth = 11
const defaultHeight= 7



const blockingMovementStrings = new Set([
    2
])

/// Begin async stuff
window.onload = async function(){
    
    /**
     * @type HTMLTextAreaElement
     */ 
    const mainScreen = document.getElementById("mainScreen")

    document.addEventListener('keydown', event => handleKeypress(event))

    function printLocation({
        x = playerLocation.x, 
        y = playerLocation.y, 
        width = defaultWidth, 
        height = defaultHeight
    }){
        const toPrint = []
        // the point (x=0, y=0) is the top left. Positive y is down.
        for (let j = y - Math.floor(height/2); j < y + Math.ceil(height / 2); j += 1){
            const row = []
            for (let i = x- Math.floor(width/2); i < x + Math.ceil(width / 2); i+=1){
                row.push(findImageFor(map[j]?.[i]))
            }
            toPrint.push(row)
        }
        // Show the player in the center instead.
        toPrint[Math.floor(height / 2)][Math.floor(width / 2)] = playerIcon[playerDirection]

        mainScreen.value = toPrint.map(row => row.join("")).join("\n")
        console.log(toPrint)
    }

    function findImageFor(mapNumber){
        if (mapNumber in imageFor){
            return imageFor[mapNumber]
        }

        return "0"
    }



    /**
     * @param {KeyboardEvent} event 
     */ 
    function handleKeypress(event){
        console.log(`"Got event ${event.key}`)

        if (event.key in directions){
            move(event.key)
        }

        if (event.key == "Enter"){
            handleInteraction(playerDirection)
        }

        printLocation({})


    }

    const playerIcon = {
        "d": "üòó",
        "s": "üôÉ",
        "a": "üßê",
        "w": "üôÇ",
    }

    const directions = {
        a: {x: -1, y: 0},
        s: {x: 0,  y: 1},
        d: {x: 1,  y: 0},
        w: {x: 0,  y: -1},
    }

    function interactingLocation(directionKey){
        const toAdd = directions[directionKey]

        return {
            x: playerLocation.x + toAdd.x,
            y: playerLocation.y + toAdd.y,
        }
    }

    function handleInteraction(playerDirection){
        console.log("Handling interaction")
        const newLocation = interactingLocation(playerDirection)
        const target = map[newLocation.y][newLocation.x]

        // For now, just increment the target by 1.
        map[newLocation.y][newLocation.x] = target + 1

    }

    function move(directionKey){
        playerDirection = directionKey
        const newLocation = interactingLocation(directionKey)

        const canMoveThere = canMove(newLocation.x, newLocation.y)

        if(canMoveThere){
            playerLocation.x = newLocation.x
            playerLocation.y = newLocation.y
        }
    }

    function canMove(x, y){
        return 0 <= y && y < map.length 
        && 0 <= x && x < map[y].length 
        && ! blockingMovementStrings.has(map[y][x])
        && map[y][x] in imageFor;
    }


    printLocation({})
}
</script>
